name: Release

on:
  release:
    types: [published]

permissions:
  contents: write
  packages: write

jobs:
  build-tarballs:
    name: Build Tarballs
    runs-on: ubuntu-latest
    outputs:
      sha256_darwin_x64: ${{ steps.checksums.outputs.darwin_x64 }}
      sha256_darwin_arm64: ${{ steps.checksums.outputs.darwin_arm64 }}
      sha256_linux_x64: ${{ steps.checksums.outputs.linux_x64 }}
      sha256_linux_arm64: ${{ steps.checksums.outputs.linux_arm64 }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        run: pnpm build

      - name: Build tarballs
        run: pnpm pack:tarballs

      - name: Calculate checksums
        id: checksums
        run: |
          cd dist
          echo "darwin_x64=$(shasum -a 256 *darwin-x64*.tar.gz | cut -d' ' -f1)" >> $GITHUB_OUTPUT
          echo "darwin_arm64=$(shasum -a 256 *darwin-arm64*.tar.gz | cut -d' ' -f1)" >> $GITHUB_OUTPUT
          echo "linux_x64=$(shasum -a 256 *linux-x64*.tar.gz | cut -d' ' -f1)" >> $GITHUB_OUTPUT
          echo "linux_arm64=$(shasum -a 256 *linux-arm64*.tar.gz | cut -d' ' -f1)" >> $GITHUB_OUTPUT

      - name: Upload tarballs to release
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*.tar.gz

  update-formula:
    name: Update Homebrew Formula
    runs-on: ubuntu-latest
    needs: build-tarballs

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: master
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Update formula
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          SHA_DARWIN_X64="${{ needs.build-tarballs.outputs.sha256_darwin_x64 }}"
          SHA_DARWIN_ARM64="${{ needs.build-tarballs.outputs.sha256_darwin_arm64 }}"
          SHA_LINUX_X64="${{ needs.build-tarballs.outputs.sha256_linux_x64 }}"
          SHA_LINUX_ARM64="${{ needs.build-tarballs.outputs.sha256_linux_arm64 }}"

          cat > Formula/pando.rb << 'FORMULA'
          class Pando < Formula
            desc "TypeScript CLI for managing Git worktrees"
            homepage "https://github.com/zpyoung/pando"
            version "VERSION_PLACEHOLDER"
            license "MIT"

            on_macos do
              on_intel do
                url "https://github.com/zpyoung/pando/releases/download/vVERSION_PLACEHOLDER/pando-vVERSION_PLACEHOLDER-darwin-x64.tar.gz"
                sha256 "SHA_DARWIN_X64_PLACEHOLDER"
              end
              on_arm do
                url "https://github.com/zpyoung/pando/releases/download/vVERSION_PLACEHOLDER/pando-vVERSION_PLACEHOLDER-darwin-arm64.tar.gz"
                sha256 "SHA_DARWIN_ARM64_PLACEHOLDER"
              end
            end

            on_linux do
              on_intel do
                url "https://github.com/zpyoung/pando/releases/download/vVERSION_PLACEHOLDER/pando-vVERSION_PLACEHOLDER-linux-x64.tar.gz"
                sha256 "SHA_LINUX_X64_PLACEHOLDER"
              end
              on_arm do
                url "https://github.com/zpyoung/pando/releases/download/vVERSION_PLACEHOLDER/pando-vVERSION_PLACEHOLDER-linux-arm64.tar.gz"
                sha256 "SHA_LINUX_ARM64_PLACEHOLDER"
              end
            end

            def install
              bin.install "pando"
            end

            test do
              assert_match version.to_s, shell_output("#{bin}/pando --version")
            end
          end
          FORMULA

          sed -i "s/VERSION_PLACEHOLDER/$VERSION/g" Formula/pando.rb
          sed -i "s/SHA_DARWIN_X64_PLACEHOLDER/$SHA_DARWIN_X64/g" Formula/pando.rb
          sed -i "s/SHA_DARWIN_ARM64_PLACEHOLDER/$SHA_DARWIN_ARM64/g" Formula/pando.rb
          sed -i "s/SHA_LINUX_X64_PLACEHOLDER/$SHA_LINUX_X64/g" Formula/pando.rb
          sed -i "s/SHA_LINUX_ARM64_PLACEHOLDER/$SHA_LINUX_ARM64/g" Formula/pando.rb

      - name: Commit updated formula
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/pando.rb
          git commit -m "chore(formula): update to ${GITHUB_REF_NAME}"
          git push

  publish-npm:
    name: Publish to npm
    runs-on: ubuntu-latest
    needs: build-tarballs

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'pnpm'
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        run: pnpm build

      - name: Publish to npm
        run: pnpm publish --no-git-checks
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
